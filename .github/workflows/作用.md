# Cursor 使用 ProxyPal + Cloudflare Tunnel 配置指南

## 背景说明

Cursor 无法直接访问本地的 `localhost` 地址，需要通过 Cloudflare Tunnel 将本地服务暴露到公网，然后在 Cursor 中配置公网 URL 来使用自定义模型。

---

## 配置步骤总览

| 步骤 | 操作位置 | 作用 | 详细说明 |
|:---:|:---:|:---|:---|
| **第一步** | Cursor | 确认 Cursor Pro 版本 | Cursor 免费版不支持自定义模型功能，必须使用 **Cursor Pro**（付费版）才能配置和使用自己的 API Key 和自定义模型 |
| **第二步** | Cloudflare | 创建 Cloudflare Tunnel | 将本地运行的 ProxyPal 服务（`localhost:8317`）暴露到公网，生成一个公网 URL（如 `https://proxy.yourdomain.com`），让 Cursor 能够访问 |
| **第三步** | Cursor | 配置自定义模型 | 在 Cursor 设置中，将 **Override OpenAI Base URL** 设置为 Cloudflare Tunnel 提供的公网 URL，让 Cursor 的请求通过你的代理服务器 |

---

## 详细步骤说明

### 第一步：确认 Cursor Pro 版本

| 项目 | 说明 |
|:---|:---|
| **前提条件** | 必须使用 Cursor Pro（付费订阅版） |
| **为什么需要** | 免费版和试用版（Pro Trial）对自定义模型/API Key 有限制 |
| **如何检查** | 打开 Cursor Settings → 查看账户信息是否显示 "Pro" 而非 "Pro Trial" |
| **不满足怎么办** | 升级到付费订阅，或使用其他支持自定义 API 的工具（如 VS Code + Continue 插件） |

---

### 第二步：创建 Cloudflare Tunnel

| 项目 | 说明 |
|:---|:---|
| **目的** | 将本地服务暴露到公网 |
| **原理** | `Cursor → 公网URL → Cloudflare → 你的电脑 localhost:8317` |
| **前提条件** | 需要 Cloudflare 账号和绑定的域名 |

#### 操作步骤：

1. **安装 cloudflared**
   - 下载地址：https://github.com/cloudflare/cloudflared/releases
   - Windows 用户下载 `cloudflared-windows-amd64.msi`

2. **在 Cloudflare 创建 Tunnel**
   - 登录 [Cloudflare Zero Trust Dashboard](https://one.dash.cloudflare.com/)
   - 进入：**网络 (Networks)** → **Tunnels**
   - 点击 **Create a tunnel**
   - 选择 **Cloudflared** 类型
   - 命名 Tunnel（如 `proxy`）
   - 复制生成的 Token

3. **配置 Public Hostname**
   
   | 设置项 | 值 |
   |:---|:---|
   | Subdomain | 自定义（如 `proxy`） |
   | Domain | 选择你的域名 |
   | Service Type | `HTTP` |
   | URL | `localhost:8317` |

4. **在本地运行 cloudflared**

   ```powershell
   # 如果遇到 QUIC 超时，使用 HTTP/2 协议
   cloudflared tunnel run --protocol http2 --token <你的token>
   ```

5. **设置为 Windows 服务（开机自启）**

   ```powershell
   # 创建配置文件（指定使用 http2 协议）
   New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\.cloudflared"
   @"
   protocol: http2
   "@ | Out-File -FilePath "$env:USERPROFILE\.cloudflared\config.yml" -Encoding UTF8
   
   # 安装服务
   cloudflared service install <你的token>
   
   # 启动服务
   net start cloudflared
   ```

---

### 第三步：在 Cursor 配置自定义模型

| 项目 | 说明 |
|:---|:---|
| **目的** | 让 Cursor 使用你的代理服务器 |
| **原理** | Cursor 默认连接 OpenAI 官方 API，通过覆盖 Base URL 可以让请求发送到你的 ProxyPal |

#### 操作步骤：

1. 打开 Cursor → **Settings** → **Models**
2. 找到 **Override OpenAI Base URL**
3. 填入你的公网 URL：
   ```
   https://proxy.yourdomain.com/v1
   ```
4. 在 **OpenAI API Key** 中填入你的 API Key
5. 在 **Models** 列表中添加或启用自定义模型

---

## 常见问题

| 问题 | 原因 | 解决方案 |
|:---|:---|:---|
| Tunnel 连接失败，显示红色 | cloudflared 没有运行或配置错误 | 检查 cloudflared 服务是否正在运行 |
| QUIC 连接超时 | 防火墙阻止了 UDP 端口 | 使用 `--protocol http2` 参数切换到 TCP |
| 429 RESOURCE_EXHAUSTED | 模型 API 配额用完 | 等待配额重置或切换模型 |
| Cursor Subscription Required | 使用的是免费版或试用版 | 升级到 Cursor Pro 付费版 |
| Invalid Model 错误 | 模型名称配置错误或不支持 | 检查自定义模型名称是否正确 |

---

## 架构流程图

```
┌─────────────┐     HTTPS      ┌──────────────────┐     内部转发     ┌────────────────┐
│   Cursor    │ ────────────► │  Cloudflare CDN  │ ─────────────► │  cloudflared   │
│  (客户端)   │                │  (公网入口)       │                │  (本地连接器)   │
└─────────────┘                └──────────────────┘                └───────┬────────┘
                                                                           │
                                                                           ▼
                                                                   ┌────────────────┐
                                                                   │   ProxyPal     │
                                                                   │ localhost:8317 │
                                                                   └───────┬────────┘
                                                                           │
                                                                           ▼
                                                                   ┌────────────────┐
                                                                   │  模型 API      │
                                                                   │ (Gemini/Claude │
                                                                   │  /OpenAI...)   │
                                                                   └────────────────┘
```
